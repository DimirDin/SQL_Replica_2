# Домашнее задание «Репликация и масштабирование. Часть 2»

Фамилия Имя: Гридин Владимир

---

## Задание 1. Преимущества схем масштабирования

### 1. Активный master + пассивный slave (репликация «в одну сторону»)

**Основные плюсы:**

- **Простота** – настройка занимает считанные минуты, не требуется специального софта-распределителя запросов.  
- **Безопасность** – slave всегда содержит «тёплую» копию данных, что снижает RPO при потере мастера.  
- **Разгрузка бэкапов** – полные логические или физические дампы можно снимать с реплики без блокировок на master.  
- **Аналитика/отчёты** – долгие SELECT-запросы можно перенести на slave, не мешая OLTP-нагрузке.  
- **Быстрое восстановление** – при сбое master достаточно «поднять» slave и переключить трафик (RTO ≈ минуты).

### 2. Master + несколько slave-серверов

**Дополнительные преимущества по сравнению с одной репликой:**
- **Горизонтальное масштабирование чтения** – чем больше читателей, тем выгоднее добавлять новые slave.  
- **Распределение нагрузки** – балансировщик (ProxySQL, HAProxy, PgBouncer, MySQL-Router) автоматически рассылает SELECT-запросы по пулу реплик.  
- **География** – slave можно разместить в разных ЦОД/регионах, уменьшая задержку для локальных пользователей.  
- **Отказоустойчивость** – потеря одной реплики не влияет на остальные; кластер продолжает обслуживать чтения.  
- **Гибкие роли** – одну реплику можно специализировать под бэкапы, вторую – под аналитику, третью – под full-text поиск.

---

## Задание 2. План горизонтального и вертикального шардинга

**Схема БД (упрощённо):**
users       (id PK, name, email, city_id, …)
books       (id PK, title, author, genre_id, price, …)
shops       (id PK, name, city_id, address, …)


**Цель:** поддерживать рост на 10× без потери производительности.

### 1. Вертикальный шард (разделение по «горячим» таблицам)

Создаём **отдельные инстансы** для каждой доменной области:


┌------------------------------┐
│  INSTANCE 1  (OLTP-users)    │
│  – users                     │
│  – user_profile              │
│  – user_sessions             │
└------------------------------┘

┌------------------------------┐
│  INSTANCE 2  (OLTP-catalog)  │
│  – books                     │
│  – authors                   │
│  – genres                    │
└------------------------------┘

┌------------------------------┐
│  INSTANCE 3  (OLTP-shops)    │
│  – shops                     │
│  – stocks (остатки)          │
│  – employees                 │
└------------------------------┘


Каждый инстанс работает в режиме **master-1 + 2×slave**.

### 2. Горизонтальный шард (разделение строк внутри таблицы)

Для таблиц, которые не умещаются в один сервер (например, `users` и `books`), включаем **шардирование по ключу**:

- `users` – шард по `user_id % 32` (32 логических шарда).  
- `books` – шард по `book_id % 16` (16 логических шарда).  
- `shops` – оставляем без шардинга (малый объём), но дублируем во все региональные ЦОД.

**Физически** логические шарды объединены в **4 кластера** (по 8/4 шардов на кластер).  
Каждый кластер = 1×master + 2×slave.

### 3. Блок-схема размещения

                   ┌---------------------------┐
                   │  Global Balancer (DNS)    │
                   └------------┬--------------┘
                                │
    ┌---------------------------┴---------------------------┐
    │        Регион «EU-Central» (физ. ЦОД Frankfurt)       │
    │                                                       │
    │  ┌-------------┐  ┌-------------┐  ┌-------------┐   │
    │  │  Shard-0    │  │  Shard-1    │  │  Shard-2    │   │
    │  │  (users)    │  │  (users)    │  │  (users)    │   │
    │  │  master-0   │  │  master-1   │  │  master-2   │   │
    │  │  + 2 slave  │  │  + 2 slave  │  │  + 2 slave  │   │
    │  └-------------┘  └-------------┘  └-------------┘   │
    │                                                       │
    │  ┌-------------┐  ┌-------------┐  ┌-------------┐   │
    │  │  Shard-0    │  │  Shard-1    │  │  Shard-2    │   │
    │  │  (books)    │  │  (books)    │  │  (books)    │   │
    │  │  master-0   │  │  master-1   │  │  master-2   │   │
    │  │  + 2 slave  │  │  + 2 slave  │  │  + 2 slave  │   │
    │  └-------------┘  └-------------┘  └-------------┘   │
    └-------------------------------------------------------┘

                   ┌---------------------------┐
                   │  Coord. Service (etcd)    │  – хранит карту шардов
                   └---------------------------┘


### 4. Режимы работы серверов

| Роль сервера | Режим         | Комментарий |
|--------------|---------------|-------------|
| master       | read-write    | Принимает все DML/DDL для своего шарда. |
| slave        | read-only     | Обслуживает SELECT, бэкапы, отчёты. |
| etcd/consul  | consensus     | Хранит метаданные: «какой шард на каком хосте». |
| proxy        | stateless     | Переписывает SQL-запросы на основе шард-ключа (ShardingSphere, Vitess, Citus). |

### 5. Пример маршрутизации запроса

Клиент → ProxySQL
↓

SELECT * FROM users WHERE id = 123456
↓

Proxy вычисляет хэш(123456) % 32 = shard-11
↓

Запрос уходит к slave-11 (если read) либо к master-11 (если write)


---
